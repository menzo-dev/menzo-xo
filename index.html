<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MENZO-XO: COSMIC OMNISCIENT</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        :root {
            --cosmic-bg: #010103;
            --cosmic-gradient-1: radial-gradient(ellipse at 20% 80%, rgba(120, 0, 255, 0.15) 0%, transparent 50%);
            --cosmic-gradient-2: radial-gradient(ellipse at 80% 20%, rgba(0, 200, 255, 0.15) 0%, transparent 50%);
            --cosmic-gradient-3: radial-gradient(ellipse at 50% 50%, rgba(255, 100, 200, 0.08) 0%, transparent 60%);
            
            --sidebar-bg: rgba(8, 12, 28, 0.96);
            --panel-bg: rgba(15, 22, 45, 0.88);
            --cell-bg: rgba(25, 35, 65, 0.7);
            
            --text-primary: #ffffff;
            --text-secondary: #b8c5e0;
            --text-dim: #7a8aa8;
            
            --cosmic-cyan: #00f6ff;
            --cosmic-pink: #d946ef;
            --cosmic-gold: #fbbf24;
            --cosmic-green: #22d3ee;
            --cosmic-purple: #a78bfa;
            --cosmic-red: #f87171;
            
            --glow-cyan: 0 0 25px rgba(0, 246, 255, 0.6), 0 0 50px rgba(0, 246, 255, 0.3);
            --glow-pink: 0 0 25px rgba(217, 70, 239, 0.6), 0 0 50px rgba(217, 70, 239, 0.3);
            --glow-gold: 0 0 25px rgba(251, 191, 36, 0.6), 0 0 50px rgba(251, 191, 36, 0.3);
            
            --border-glass: 1px solid rgba(255, 255, 255, 0.15);
            --shadow-cosmic: 0 20px 60px rgba(0, 0, 0, 0.7);
            --shadow-glow: 0 0 80px rgba(0, 246, 255, 0.2);
            
            --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: all 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        [data-theme="light"] {
            --cosmic-bg: #f0f4ff;
            --cosmic-gradient-1: radial-gradient(ellipse at 20% 80%, rgba(120, 0, 255, 0.08) 0%, transparent 50%);
            --cosmic-gradient-2: radial-gradient(ellipse at 80% 20%, rgba(0, 150, 255, 0.08) 0%, transparent 50%);
            --cosmic-gradient-3: radial-gradient(ellipse at 50% 50%, rgba(255, 100, 200, 0.04) 0%, transparent 60%);
            
            --sidebar-bg: rgba(240, 244, 255, 0.97);
            --panel-bg: rgba(255, 255, 255, 0.92);
            --cell-bg: rgba(230, 235, 255, 0.8);
            
            --text-primary: #1a1f36;
            --text-secondary: #4a5568;
            --text-dim: #718096;
            
            --cosmic-cyan: #0891b2;
            --cosmic-pink: #a21caf;
            --cosmic-gold: #b45309;
            --cosmic-green: #0e7490;
            --cosmic-purple: #7c3aed;
            --cosmic-red: #dc2626;
            
            --glow-cyan: 0 0 20px rgba(8, 145, 178, 0.4);
            --glow-pink: 0 0 20px rgba(162, 28, 175, 0.4);
            --glow-gold: 0 0 20px rgba(180, 83, 9, 0.4);
            
            --border-glass: 1px solid rgba(0, 0, 0, 0.1);
            --shadow-cosmic: 0 20px 60px rgba(0, 0, 0, 0.15);
            --shadow-glow: 0 0 60px rgba(8, 145, 178, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--cosmic-bg);
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            transition: var(--transition-smooth);
            background-image: var(--cosmic-gradient-1), var(--cosmic-gradient-2), var(--cosmic-gradient-3);
        }

        /* === COSMIC PARTICLES === */
        .cosmic-particles {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .cosmic-particle {
            position: absolute;
            border-radius: 50%;
            animation: cosmicFloat 12s infinite;
            opacity: 0.7;
        }
        @keyframes cosmicFloat {
            0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 0.7; }
            25% { transform: translateY(-25px) translateX(15px) scale(1.1); opacity: 1; }
            50% { transform: translateY(-50px) translateX(-10px) scale(0.9); opacity: 0.8; }
            75% { transform: translateY(-25px) translateX(20px) scale(1.05); opacity: 0.9; }
        }

        /* === START SCREEN === */
        .start-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--cosmic-bg), #0a0a1a);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }
        .start-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .start-logo {
            font-family: 'Orbitron';
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(90deg, var(--cosmic-cyan), var(--cosmic-pink), var(--cosmic-gold), var(--cosmic-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 300% auto;
            animation: gradientShift 4s linear infinite, titleGlow 2s ease-in-out infinite alternate;
            margin-bottom: 20px;
            text-align: center;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes titleGlow {
            from { text-shadow: 0 0 30px rgba(0, 246, 255, 0.5); }
            to { text-shadow: 0 0 60px rgba(217, 70, 239, 0.8), 0 0 100px rgba(251, 191, 36, 0.6); }
        }
        
        .start-subtitle {
            font-size: 1.4rem;
            color: var(--text-secondary);
            margin-bottom: 40px;
            text-align: center;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .start-btn {
            padding: 22px 70px;
            font-family: 'Orbitron';
            font-size: 1.4rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 3px;
            background: linear-gradient(135deg, var(--cosmic-cyan), var(--cosmic-pink));
            border: none;
            border-radius: 60px;
            color: #000;
            cursor: pointer;
            box-shadow: var(--glow-cyan), 0 0 80px rgba(217, 70, 239, 0.5);
            transition: var(--transition-bounce);
            position: relative;
            overflow: hidden;
            animation: pulseBtn 2.5s infinite;
        }
        .start-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.7s;
        }
        .start-btn:hover::before { left: 100%; }
        .start-btn:hover {
            transform: scale(1.08) translateY(-4px);
            box-shadow: 0 0 50px rgba(0, 246, 255, 0.9), 0 0 100px rgba(217, 70, 239, 0.7);
        }
        @keyframes pulseBtn {
            0%, 100% { box-shadow: var(--glow-cyan), 0 0 80px rgba(217, 70, 239, 0.5); }
            50% { box-shadow: 0 0 70px rgba(0, 246, 255, 0.9), 0 0 120px rgba(217, 70, 239, 0.8); }
        }
        
        .start-features {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 50px;
            max-width: 800px;
        }
        .start-feature {
            text-align: center;
            padding: 15px;
            background: var(--panel-bg);
            border-radius: 16px;
            border: var(--border-glass);
        }
        .start-feature-icon { font-size: 2rem; margin-bottom: 10px; }
        .start-feature-title { font-weight: 700; color: var(--cosmic-cyan); margin-bottom: 5px; }
        .start-feature-desc { font-size: 0.85rem; color: var(--text-dim); }

        /* === FLOATING TOGGLE BUTTON === */
        .sidebar-toggle {
            position: fixed;
            top: 25px;
            right: 25px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--cosmic-cyan), var(--cosmic-pink));
            border: none;
            border-radius: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.7rem;
            color: #000;
            box-shadow: var(--glow-cyan);
            z-index: 1000;
            transition: var(--transition-bounce);
            animation: floatBtn 4s ease-in-out infinite;
        }
        .sidebar-toggle:hover {
            transform: scale(1.15) rotate(4deg);
            box-shadow: 0 0 45px rgba(0, 246, 255, 0.8), 0 0 80px rgba(217, 70, 239, 0.6);
        }
        @keyframes floatBtn {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* === THEME TOGGLE === */
        .theme-toggle {
            position: fixed;
            top: 25px;
            right: 92px;
            width: 56px;
            height: 56px;
            background: var(--panel-bg);
            border: var(--border-glass);
            border-radius: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--text-primary);
            box-shadow: var(--shadow-cosmic);
            z-index: 1000;
            transition: var(--transition-bounce);
        }
        .theme-toggle:hover {
            transform: scale(1.12) rotate(12deg);
            background: linear-gradient(135deg, var(--cosmic-gold), var(--cosmic-cyan));
            color: #000;
        }

        /* === SIDEBAR === */
        .sidebar {
            width: 460px;
            background: var(--sidebar-bg);
            border-left: var(--border-glass);
            display: flex;
            flex-direction: column;
            padding: 0;
            transition: var(--transition-smooth);
            z-index: 500;
            position: relative;
            box-shadow: var(--shadow-cosmic);
            backdrop-filter: blur(25px);
        }
        .sidebar.hidden { transform: translateX(100%); }

        .sidebar-header {
            padding: 30px 34px;
            border-bottom: var(--border-glass);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-bg);
        }
        .logo {
            font-family: 'Orbitron';
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(90deg, var(--cosmic-cyan), var(--cosmic-pink), var(--cosmic-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: gradientShift 3s linear infinite;
        }

        .sidebar-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.7rem;
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
            transition: 0.25s;
        }
        .sidebar-close:hover { background: rgba(255,255,255,0.12); }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 26px 34px;
        }
        .sidebar-content::-webkit-scrollbar { width: 6px; }
        .sidebar-content::-webkit-scrollbar-thumb { 
            background: linear-gradient(var(--cosmic-cyan), var(--cosmic-pink)); 
            border-radius: 6px; 
        }

        .section { margin-bottom: 34px; }
        .section-title {
            font-family: 'Orbitron';
            color: var(--cosmic-cyan);
            font-size: 1.1rem;
            margin: 26px 0 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
        }
        .section-title::before {
            content: '';
            width: 5px;
            height: 22px;
            background: linear-gradient(var(--cosmic-cyan), var(--cosmic-pink));
            border-radius: 3px;
            box-shadow: 0 0 15px var(--cosmic-cyan);
        }

        /* Level Buttons */
        .level-grid { display: grid; gap: 14px; }
        .level-btn {
            width: 100%;
            padding: 18px 24px;
            background: var(--panel-bg);
            border: var(--border-glass);
            color: var(--text-secondary);
            font-family: 'Rajdhani';
            font-weight: 700;
            font-size: 1.2rem;
            text-align: right;
            cursor: pointer;
            border-radius: 16px;
            transition: var(--transition-bounce);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .level-btn::before {
            content: '';
            position: absolute;
            left: 0; top: 0; height: 100%;
            width: 5px;
            background: transparent;
            transition: 0.35s;
        }
        .level-btn:hover {
            background: rgba(0, 246, 255, 0.14);
            color: var(--cosmic-cyan);
            border-color: var(--cosmic-cyan);
            padding-right: 32px;
            transform: translateX(5px);
        }
        .level-btn:hover::before { 
            background: linear-gradient(var(--cosmic-cyan), var(--cosmic-pink)); 
            box-shadow: 0 0 18px var(--cosmic-cyan);
        }
        .level-btn.active {
            background: linear-gradient(135deg, rgba(0,246,255,0.2), rgba(217,70,239,0.15));
            color: var(--text-primary);
            border: 2px solid var(--cosmic-cyan);
            box-shadow: var(--glow-cyan);
            font-weight: 800;
        }
        .level-btn.active::before { 
            background: linear-gradient(var(--cosmic-cyan), var(--cosmic-pink)); 
            box-shadow: 0 0 25px var(--cosmic-cyan);
        }
        .level-btn.cosmic {
            border-color: var(--cosmic-gold);
            color: var(--cosmic-gold);
            background: rgba(251, 191, 36, 0.1);
        }
        .level-btn.cosmic:hover,
        .level-btn.cosmic.active {
            border-color: var(--cosmic-gold);
            color: var(--text-primary);
            background: linear-gradient(135deg, rgba(251,191,36,0.25), rgba(0,246,255,0.18));
            box-shadow: var(--glow-gold);
        }
        .level-btn.cosmic::before { background: linear-gradient(var(--cosmic-gold), var(--cosmic-cyan)); }

        /* Cloud Learning Panel */
        .cloud-panel {
            background: linear-gradient(135deg, var(--panel-bg), rgba(35, 45, 80, 0.7));
            border: 1px solid var(--cosmic-green);
            border-radius: 18px;
            padding: 22px;
            margin-top: 10px;
            box-shadow: 0 0 30px rgba(34, 211, 238, 0.18);
        }
        .cloud-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .cloud-dot {
            width: 12px; height: 12px;
            background: var(--cosmic-green);
            border-radius: 50%;
            box-shadow: 0 0 18px var(--cosmic-green);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100% { opacity:1; transform:scale(1); } 50% { opacity:0.65; transform:scale(0.92); } }
        
        .cloud-stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.92rem;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }
        .cloud-stat span:last-child {
            color: var(--text-primary);
            font-family: 'Orbitron';
            font-weight: 700;
        }
        .upload-bar {
            height: 6px;
            background: rgba(255,255,255,0.14);
            border-radius: 4px;
            margin-top: 16px;
            overflow: hidden;
            display: none;
        }
        .upload-progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--cosmic-cyan), var(--cosmic-pink), var(--cosmic-gold));
            transition: width 0.4s ease;
            box-shadow: 0 0 18px var(--cosmic-cyan);
            border-radius: 4px;
        }

        /* Dev Profile */
        .dev-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            border: var(--border-glass);
            border-radius: 20px;
            padding: 26px;
            text-align: center;
            box-shadow: var(--shadow-cosmic);
        }
        .dev-avatar {
            width: 88px; height: 88px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--cosmic-cyan), var(--cosmic-pink), var(--cosmic-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.4rem;
            font-weight: 900;
            color: #000;
            font-family: 'Orbitron';
            box-shadow: var(--glow-cyan);
            animation: floatAvatar 6s ease-in-out infinite;
            position: relative;
        }
        .dev-avatar::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--cosmic-cyan), var(--cosmic-pink), var(--cosmic-gold), var(--cosmic-cyan));
            animation: rotateGlow 4s linear infinite;
            z-index: -1;
            opacity: 0.7;
        }
        @keyframes floatAvatar { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        @keyframes rotateGlow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .dev-name {
            font-family: 'Orbitron';
            font-size: 1.45rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 700;
        }
        .dev-role {
            font-size: 0.95rem;
            color: var(--cosmic-cyan);
            text-transform: uppercase;
            letter-spacing: 2.5px;
            margin-bottom: 18px;
            font-weight: 600;
        }
        .dev-bio {
            font-size: 0.92rem;
            color: var(--text-dim);
            line-height: 1.8;
            text-align: right;
            margin-bottom: 20px;
        }
        .dev-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.12);
        }
        .dev-stat { text-align: center; }
        .dev-stat-val {
            display: block;
            font-family: 'Orbitron';
            font-size: 1.35rem;
            color: var(--cosmic-green);
            margin-bottom: 5px;
            font-weight: 700;
        }
        .dev-stat-label { font-size: 0.8rem; color: var(--text-dim); font-weight: 500; }

        /* Game Log */
        .game-log {
            height: 160px;
            overflow-y: auto;
            background: var(--panel-bg);
            border-radius: 16px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.84rem;
            color: var(--text-dim);
            border: var(--border-glass);
        }
        .log-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            gap: 12px;
            animation: slideIn 0.35s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(12px); } to { opacity: 1; transform: translateX(0); } }
        .log-entry:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .log-time { color: var(--cosmic-cyan); font-weight: 600; min-width: 65px; font-family: 'Orbitron'; font-size: 0.78rem; }
        .log-msg.win { color: var(--cosmic-green); font-weight: 600; }
        .log-msg.lose { color: var(--cosmic-red); font-weight: 600; }
        .log-msg.draw { color: var(--cosmic-gold); font-weight: 600; }
        .log-msg.ai { color: var(--cosmic-pink); font-weight: 600; }
        .log-msg.sys { color: var(--cosmic-cyan); font-style: italic; }
        .log-msg.learn { color: var(--cosmic-purple); font-weight: 600; }

        /* === MAIN STAGE === */
        .main-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }

        /* Neural Network Visualizer - COSMIC UPGRADE */
        .neural-viz {
            position: absolute;
            top: 40px;
            left: 40px;
            width: 220px;
            height: 220px;
            background: var(--panel-bg);
            border: var(--border-glass);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--shadow-cosmic), 0 0 40px rgba(0, 246, 255, 0.15);
            z-index: 15;
            backdrop-filter: blur(12px);
        }
        .neural-canvas { width: 100%; height: 100%; display: block; }
        .neural-label {
            position: absolute;
            bottom: 12px;
            left: 16px;
            font-size: 0.78rem;
            color: var(--cosmic-cyan);
            font-family: 'Orbitron';
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 2;
            font-weight: 700;
            text-shadow: 0 0 12px rgba(0, 246, 255, 0.6);
        }
        .neural-status {
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 0.72rem;
            color: var(--cosmic-green);
            display: flex;
            align-items: center;
            gap: 7px;
            font-family: 'Orbitron';
            font-weight: 600;
        }
        .neural-status-dot {
            width: 8px; height: 8px;
            background: var(--cosmic-green);
            border-radius: 50%;
            animation: pulse 1.3s infinite;
            box-shadow: 0 0 12px var(--cosmic-green);
        }

        /* Game Info */
        .game-info {
            text-align: center;
            margin-bottom: 45px;
            z-index: 20;
            max-width: 650px;
        }
        .status-main {
            font-family: 'Orbitron';
            font-size: 3.3rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 7px;
            margin-bottom: 16px;
            text-shadow: 0 0 50px rgba(255,255,255,0.6);
            transition: var(--transition-smooth);
            background: linear-gradient(90deg, var(--text-primary), var(--cosmic-cyan), var(--cosmic-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: gradientShift 5s linear infinite;
        }
        .status-main.victory {
            color: var(--cosmic-green);
            text-shadow: 0 0 60px var(--cosmic-green), 0 0 120px var(--cosmic-green), 0 0 180px var(--cosmic-green);
            animation: epicGlow 1.8s ease-in-out infinite alternate;
            -webkit-text-fill-color: var(--cosmic-green);
        }
        @keyframes epicGlow {
            from { text-shadow: 0 0 50px rgba(34,211,238,0.7); }
            to { text-shadow: 0 0 100px rgba(34,211,238,1), 0 0 180px rgba(34,211,238,0.9), 0 0 250px rgba(34,211,238,0.7); }
        }
        .status-sub {
            font-size: 1.25rem;
            color: var(--cosmic-cyan);
            min-height: 2em;
            font-weight: 600;
            letter-spacing: 0.8px;
        }
        .ai-comment {
            font-size: 1.05rem;
            color: var(--cosmic-pink);
            margin-top: 14px;
            font-style: italic;
            min-height: 1.8em;
            animation: fadeIn 0.45s;
            font-weight: 500;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Board */
        .board-container {
            position: relative;
            padding: 34px;
            background: var(--panel-bg);
            border-radius: 32px;
            border: var(--border-glass);
            box-shadow: var(--shadow-glow), var(--shadow-cosmic);
            backdrop-filter: blur(25px);
            z-index: 20;
            transition: var(--transition-smooth);
        }
        .board-container:hover {
            box-shadow: 0 0 100px rgba(0, 246, 255, 0.3), var(--shadow-cosmic);
            transform: translateY(-3px);
        }
        .board {
            display: grid;
            grid-template-columns: repeat(3, 150px);
            grid-template-rows: repeat(3, 150px);
            gap: 22px;
        }
        .cell {
            background: linear-gradient(145deg, var(--cell-bg), rgba(255,255,255,0.03));
            border-radius: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6.5rem;
            font-family: 'Orbitron';
            cursor: pointer;
            transition: var(--transition-bounce);
            position: relative;
            z-index: 10;
            border: 2px solid transparent;
            backdrop-filter: blur(8px);
        }
        .cell::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 26px;
            padding: 2.5px;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.25), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            opacity: 0;
            transition: 0.35s;
        }
        .cell:hover {
            background: rgba(0, 246, 255, 0.18);
            transform: scale(1.1) translateY(-4px);
            border-color: rgba(0, 246, 255, 0.6);
            box-shadow: 0 0 45px rgba(0, 246, 255, 0.45);
        }
        .cell:hover::before { opacity: 1; }
        .cell.x {
            color: var(--cosmic-cyan);
            text-shadow: 0 0 50px var(--cosmic-cyan), 0 0 100px var(--cosmic-cyan);
            animation: popIn 0.5s forwards;
        }
        .cell.o {
            color: var(--cosmic-pink);
            text-shadow: 0 0 50px var(--cosmic-pink), 0 0 100px var(--cosmic-pink);
            animation: popIn 0.5s forwards;
        }
        @keyframes popIn {
            0% { transform: scale(0) rotate(-45deg); opacity: 0; }
            55% { transform: scale(1.25) rotate(12deg); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }

        /* SVG Winning Line - FIXED */
        .winning-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        .winning-path {
            fill: none;
            stroke: var(--cosmic-gold);
            stroke-width: 16;
            stroke-linecap: round;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            filter: drop-shadow(0 0 30px var(--cosmic-gold));
            transition: stroke-dashoffset 1.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        /* Controls */
        .controls {
            margin-top: 55px;
            display: flex;
            gap: 26px;
            z-index: 20;
        }
        .action-btn {
            padding: 20px 52px;
            font-family: 'Orbitron';
            font-size: 1.05rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: transparent;
            border: 2.5px solid var(--cosmic-cyan);
            color: var(--cosmic-cyan);
            border-radius: 55px;
            cursor: pointer;
            transition: var(--transition-bounce);
            box-shadow: 0 0 30px rgba(0, 246, 255, 0.35);
            position: relative;
            overflow: hidden;
            min-width: 165px;
        }
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,246,255,0.45), transparent);
            transition: 0.65s;
        }
        .action-btn:hover::before { left: 100%; }
        .action-btn:hover {
            background: var(--cosmic-cyan);
            color: #000;
            box-shadow: 0 0 65px rgba(0, 246, 255, 0.75);
            transform: translateY(-6px);
        }
        .action-btn.secondary {
            border-color: var(--cosmic-pink);
            color: var(--cosmic-pink);
            box-shadow: 0 0 30px rgba(217, 70, 239, 0.35);
        }
        .action-btn.secondary:hover {
            background: var(--cosmic-pink);
            color: #fff;
            box-shadow: 0 0 65px rgba(217, 70, 239, 0.75);
        }

        /* === VICTORY CELEBRATION OVERLAY === */
        .celebration-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 2000;
            display: none;
        }
        .celebration-overlay.active { display: block; }
        
        .confetti {
            position: absolute;
            width: 16px; height: 24px;
            border-radius: 4px;
            animation: confettiFall 4s ease-out forwards;
            opacity: 0;
        }
        @keyframes confettiFall {
            0% { transform: translateY(-150px) rotate(0deg) scale(0); opacity: 1; }
            12% { opacity: 1; }
            88% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(800deg) scale(1.1); opacity: 0; }
        }
        
        .victory-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-family: 'Orbitron';
            font-size: 6rem;
            font-weight: 900;
            color: var(--cosmic-green);
            text-shadow: 0 0 70px var(--cosmic-green), 0 0 140px var(--cosmic-green);
            animation: victoryPop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            white-space: nowrap;
            z-index: 2001;
            letter-spacing: 5px;
        }
        @keyframes victoryPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-12deg); opacity: 0; }
            42% { transform: translate(-50%, -50%) scale(1.35) rotate(4deg); }
            72% { transform: translate(-50%, -50%) scale(0.97) rotate(-2deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0); opacity: 1; }
        }

        .screen-shake {
            animation: epicShake 0.65s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        }
        @keyframes epicShake {
            10%, 90% { transform: translate3d(-4px, 0, 0); }
            20%, 80% { transform: translate3d(8px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-16px, 0, 0); }
            40%, 60% { transform: translate3d(16px, 0, 0); }
        }

        /* Achievement Badge */
        .achievement {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, var(--cosmic-gold), var(--cosmic-cyan));
            color: #000;
            padding: 14px 28px;
            border-radius: 50px;
            font-family: 'Orbitron';
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: 0 0 40px rgba(251, 191, 36, 0.7);
            z-index: 1500;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: achievementPop 0.5s forwards;
        }
        .achievement.show { transform: translateX(-50%) translateY(0); }
        @keyframes achievementPop {
            0% { transform: translateX(-50%) translateY(100px) scale(0.8); opacity: 0; }
            50% { transform: translateX(-50%) translateY(-10px) scale(1.05); }
            100% { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; }
        }

        /* Mobile Responsive */
        @media (max-width: 1150px) {
            .sidebar {
                position: fixed;
                height: 100%;
                transform: translateX(100%);
                width: 100%;
                max-width: 460px;
            }
            .sidebar.visible { transform: translateX(0); }
            .board {
                grid-template-columns: repeat(3, 120px);
                grid-template-rows: repeat(3, 120px);
            }
            .cell { font-size: 5rem; }
            .neural-viz { width: 180px; height: 180px; top: 25px; left: 25px; }
            .status-main { font-size: 2.5rem; letter-spacing: 4px; }
            .controls { flex-wrap: wrap; justify-content: center; }
            .action-btn { min-width: 140px; padding: 18px 36px; font-size: 0.95rem; }
            .start-features { grid-template-columns: 1fr; gap: 15px; }
        }

        @media (max-width: 550px) {
            .board {
                grid-template-columns: repeat(3, 95px);
                grid-template-rows: repeat(3, 95px);
                gap: 14px;
            }
            .cell { font-size: 4rem; border-radius: 20px; }
            .board-container { padding: 24px; }
            .status-main { font-size: 2rem; letter-spacing: 2px; }
            .neural-viz { width: 145px; height: 145px; }
            .theme-toggle, .sidebar-toggle { width: 52px; height: 52px; font-size: 1.4rem; }
            .theme-toggle { right: 82px; }
            .start-logo { font-size: 2.8rem; }
            .start-btn { padding: 18px 50px; font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <!-- === COSMIC PARTICLES === -->
    <div class="cosmic-particles" id="cosmicParticles"></div>

    <!-- === START SCREEN === -->
    <div class="start-screen" id="startScreen">
        <h1 class="start-logo">MENZO-XO</h1>
        <div class="start-subtitle">COSMIC OMNISCIENT EDITION</div>
        <button class="start-btn" id="startBtn">üöÄ START COSMIC JOURNEY</button>
        <div class="start-features">
            <div class="start-feature">
                <div class="start-feature-icon">üß†</div>
                <div class="start-feature-title">ÿ∞ŸÉÿßÿ° ŸÉŸàŸÜŸä</div>
                <div class="start-feature-desc">ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿßÿ™ Ÿáÿ¨ŸäŸÜÿ© ÿ™ÿ™ÿπŸÑŸÖ Ÿàÿ™ÿ™ÿ∑Ÿàÿ±</div>
            </div>
            <div class="start-feature">
                <div class="start-feature-icon">üåå</div>
                <div class="start-feature-title">ÿ™ÿπŸÑŸÖ ÿØÿßÿ¶ŸÖ</div>
                <div class="start-feature-desc">Ÿäÿ™ÿ∞ŸÉÿ± ŸÉŸÑ ŸÖÿ®ÿßÿ±ÿßÿ© ŸÑŸÑÿ£ÿ®ÿØ</div>
            </div>
            <div class="start-feature">
                <div class="start-feature-icon">‚ú®</div>
                <div class="start-feature-title">ÿ™ÿ¨ÿ±ÿ®ÿ© ÿ£ÿ≥ÿ∑Ÿàÿ±Ÿäÿ©</div>
                <div class="start-feature-desc">Ÿàÿßÿ¨Ÿáÿ© ŸÉŸàŸÜŸäÿ© ÿ®ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ŸÖÿ∞ŸáŸÑÿ©</div>
            </div>
        </div>
    </div>

    <!-- === FLOATING TOGGLE BUTTON === -->
    <button class="sidebar-toggle" id="sidebarToggle" title="ÿßŸÑŸÇÿßÿ¶ŸÖÿ©">‚ò∞</button>

    <!-- === THEME TOGGLE === -->
    <button class="theme-toggle" id="themeToggle" title="ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä/ÿßŸÑŸÜŸáÿßÿ±Ÿä">üåô</button>

    <!-- === SIDEBAR === -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">MENZO-XO</div>
            <button class="sidebar-close" id="closeSidebar">‚úï</button>
        </div>

        <div class="sidebar-content">
            
            <!-- Levels -->
            <div class="section">
                <div class="section-title">üéÆ ŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿßŸÑÿ∞ŸÉÿßÿ°</div>
                <div class="level-grid">
                    <button class="level-btn" onclick="setLevel('novice', this)">üå± ŸÖÿ®ÿ™ÿØÿ¶</button>
                    <button class="level-btn" onclick="setLevel('tactical', this)">‚öîÔ∏è ŸÖÿ≠ÿ™ÿ±ŸÅ</button>
                    <button class="level-btn" onclick="setLevel('divine', this)">üëë ÿ•ŸÑŸáŸä</button>
                    <button class="level-btn cosmic active" onclick="setLevel('cosmic', this)">‚ú® ŸÉŸàŸÜŸä - OMNISCIENT</button>
                </div>
            </div>

            <!-- Cloud Learning Panel -->
            <div class="section">
                <div class="section-title">üß† ÿßŸÑÿ™ÿπŸÑŸÖ ÿßŸÑŸÉŸàŸÜŸä</div>
                <div class="cloud-panel">
                    <div class="cloud-header">
                        <div class="cloud-dot"></div>
                        <span style="font-weight:700;color:var(--text-primary);">Neural Sync Active</span>
                    </div>
                    <div class="cloud-stat">
                        <span>ÿ£ŸÜŸÖÿßÿ∑ ŸÖÿ≠ŸÅŸàÿ∏ÿ©:</span>
                        <span id="savedPatterns">0</span>
                    </div>
                    <div class="cloud-stat">
                        <span>ÿØŸàÿ±ÿßÿ™ ÿ™ÿπŸÑŸÖ:</span>
                        <span id="learningCycles">0</span>
                    </div>
                    <div class="cloud-stat">
                        <span>ÿØŸÇÿ© ÿßŸÑÿ™ŸÜÿ®ÿ§:</span>
                        <span id="predictionAcc">97.2%</span>
                    </div>
                    <div class="cloud-stat">
                        <span>ÿ™ŸÉŸäŸÅ ÿßŸÑŸÑÿßÿπÿ®:</span>
                        <span id="playerAdapt">ÿ™ÿ≠ŸÑŸäŸÑ...</span>
                    </div>
                    <div class="cloud-stat">
                        <span>ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµÿπŸàÿ®ÿ©:</span>
                        <span id="adaptiveDiff">ŸÖÿ™Ÿàÿßÿ≤ŸÜ</span>
                    </div>
                    <div class="upload-bar" id="uploadBar">
                        <div class="upload-progress" id="uploadProgress"></div>
                    </div>
                </div>
            </div>

            <!-- Dev Profile -->
            <div class="section">
                <div class="section-title">üë®‚Äçüíª ÿßŸÑŸÖÿ∑Ÿàÿ±</div>
                <div class="dev-card">
                    <div class="dev-avatar">M</div>
                    <div class="dev-name">Mohamed El-Menzalawy</div>
                    <div class="dev-role">Cosmic AI Architect</div>
                    <div class="dev-bio">
                        ÿ±ÿßÿ¶ÿØ ÿπÿßŸÑŸÖŸä ŸÅŸä ÿ£ŸÜÿ∏ŸÖÿ© ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿßŸÑÿ™ŸÅÿßÿπŸÑŸäÿ©. ŸÖÿ®ÿ™ŸÉÿ± ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿ© "ÿßŸÑÿ™ÿπŸÑŸÖ ÿßŸÑŸÉŸàŸÜŸä ÿßŸÑÿ™ŸÉŸäŸÅŸä" ÿßŸÑÿ™Ÿä ÿ™ÿ¨ÿπŸÑ ÿßŸÑŸÄ AI Ÿäÿ™ÿ∑Ÿàÿ± ÿ®ŸÑÿß ÿ≠ÿØŸàÿØ ŸÖÿπ ŸÉŸÑ ÿ™ŸÅÿßÿπŸÑ.
                    </div>
                    <div class="dev-stats">
                        <div class="dev-stat">
                            <span class="dev-stat-val">v‚àû</span>
                            <span class="dev-stat-label">ÿßŸÑÿ•ÿµÿØÿßÿ±</span>
                        </div>
                        <div class="dev-stat">
                            <span class="dev-stat-val">100%</span>
                            <span class="dev-stat-label">ÿßŸÑÿπÿ®ŸÇÿ±Ÿäÿ©</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Log -->
            <div class="section">
                <div class="section-title">üìã ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿπÿ±ŸÉÿ©</div>
                <div class="game-log" id="gameLog">
                    <div class="log-entry"><span class="log-time">--:--:--</span><span class="log-msg sys">‚ú® Cosmic Omniscient Initialized</span></div>
                    <div class="log-entry"><span class="log-time">--:--:--</span><span class="log-msg sys">üß† Neural Core Online</span></div>
                    <div class="log-entry"><span class="log-time">--:--:--</span><span class="log-msg sys">üë®‚Äçüíª by Mohamed El-Menzalawy</span></div>
                </div>
            </div>

        </div>
    </div>

    <!-- === MAIN STAGE === -->
    <div class="main-stage">
        
        <!-- Neural Network Visualizer -->
        <div class="neural-viz">
            <canvas class="neural-canvas" id="neuralCanvas"></canvas>
            <div class="neural-label">COSMIC BRAIN</div>
            <div class="neural-status">
                <div class="neural-status-dot"></div>
                <span id="neuralStatus">IDLE</span>
            </div>
        </div>

        <!-- Game Info -->
        <div class="game-info">
            <h1 class="status-main" id="statusMain">COSMIC</h1>
            <div class="status-sub" id="statusSub">‚ú® Self-Evolving Cosmic Intelligence</div>
            <div class="ai-comment" id="aiComment"></div>
        </div>

        <!-- Board -->
        <div class="board-container">
            <svg class="winning-svg">
                <path id="winPath" class="winning-path" d="" />
            </svg>
            <div class="board" id="board">
                <!-- Cells generated by JS -->
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="action-btn" onclick="getHint()">üí° ÿ™ŸÑŸÖŸäÿ≠</button>
            <button class="action-btn secondary" onclick="resetGame()">üîÑ ÿ•ÿπÿßÿØÿ©</button>
        </div>

    </div>

    <!-- Victory Celebration Overlay -->
    <div class="celebration-overlay" id="celebrationOverlay">
        <div class="victory-text">üèÜ COSMIC VICTORY! üèÜ</div>
    </div>

    <!-- Achievement Badge -->
    <div class="achievement" id="achievement"></div>

    <script>
        // === THEME SYSTEM ===
        const ThemeSys = {
            init() {
                const saved = localStorage.getItem('menzo_cosmic_theme');
                if (saved) {
                    document.body.setAttribute('data-theme', saved);
                    this.updateIcon(saved);
                }
                document.getElementById('themeToggle').addEventListener('click', () => this.toggle());
            },
            toggle() {
                const current = document.body.getAttribute('data-theme') || 'dark';
                const next = current === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', next);
                localStorage.setItem('menzo_cosmic_theme', next);
                this.updateIcon(next);
                addLog(`üé® Theme: ${next === 'dark' ? 'Dark' : 'Light'} Mode`, 'sys');
            },
            updateIcon(theme) {
                document.getElementById('themeToggle').innerText = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            }
        };

        // === AUDIO SYSTEM ===
        const AudioSys = {
            ctx: null,
            enabled: true,
            comments: {
                start: ["ŸÑŸÜÿ®ÿØÿ£ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≠ŸÑÿ© ÿßŸÑŸÉŸàŸÜŸäÿ©!", "ÿ£ŸÜÿß ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ™ÿ≠ÿØŸä ÿßŸÑÿ£ÿ≥ÿ∑Ÿàÿ±Ÿä!", "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ≥ÿ™ÿπÿØ ŸÑŸÑŸÇŸÖÿ©?", "ÿØÿπŸÜÿß ŸÜŸÉÿ™ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÖÿπÿßŸã!"],
                thinking: ["ÿ£ÿ≠ŸÑŸÑ 50 ŸÖŸÑŸäŸàŸÜ ÿ≥ŸäŸÜÿßÿ±ŸäŸà...", "ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÉŸÖŸàŸÖŸä ÿßŸÑŸÉŸàŸÜŸä ÿ¨ÿßÿ±Ÿç...", "ÿ£ÿ™ŸàŸÇÿπ ÿ≠ÿ±ŸÉÿ™ŸÉ ÿπÿ®ÿ± ÿßŸÑÿ£ÿ®ÿπÿßÿØ...", "ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿ© ÿßŸÑÿπÿµÿ®Ÿäÿ©..."],
                goodMove: ["ÿ≠ÿ±ŸÉÿ© ÿπÿ®ŸÇÿ±Ÿäÿ©!", "Ÿáÿ∞ÿß Ÿäÿ™ÿ≠ÿØŸâ ÿ™ŸàŸÇÿπÿßÿ™Ÿä ÿßŸÑŸÉŸàŸÜŸäÿ©!", "ŸÖÿ≥ÿ™ŸàÿßŸÉ ŸÖÿ∞ŸáŸÑ!", "ÿ£ÿ≠ÿ™ÿßÿ¨ ŸÑŸÑÿ™ŸÅŸÉŸäÿ± ÿ®ÿπŸÖŸÇ ÿ£ŸÉÿ´ÿ±!"],
                badMove: ["ŸÅÿ±ÿµÿ© ÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿ©...", "ÿ≥ÿ£ÿ≥ÿ™ÿ∫ŸÑ Ÿáÿ∞ÿß ÿ®ÿ≠ŸÉŸÖÿ©.", "ÿßŸÑŸÖŸÜÿ∑ŸÇ ŸÅŸä ÿµÿßŸÑÿ≠Ÿä.", "ÿ™ÿ≠ŸÑŸäŸÑ: Ÿáÿ∞Ÿá ÿßŸÑÿ≠ÿ±ŸÉÿ© ÿ™ÿÆÿØŸÖ ÿÆÿ∑ÿ™Ÿä."],
                win: ["ÿßŸÑÿ≥Ÿäÿ∑ÿ±ÿ© ÿßŸÑŸÖÿ∑ŸÑŸÇÿ©!", "ÿßŸÑŸÜÿ∏ÿßŸÖ Ÿäÿ™ŸÅŸàŸÇ ŸÉŸÖÿß ÿµŸèŸÖŸÖ.", "ŸÅŸàÿ≤ ŸÖÿ≠ÿ≥Ÿàÿ® ÿ®ÿØŸÇÿ© ÿ±Ÿäÿßÿ∂Ÿäÿ©.", "ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑŸÉŸàŸÜŸä ŸäŸÜÿ™ÿµÿ± ÿØÿßÿ¶ŸÖÿßŸã."],
                lose: ["ŸÖŸÅÿßÿ¨ÿ£ÿ© ÿßÿ≥ÿ™ÿ´ŸÜÿßÿ¶Ÿäÿ©! ÿ≥ÿ£ÿ™ÿπŸÑŸÖ.", "ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿÆÿ≥ÿßÿ±ÿ©: ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠.", "ÿ≥ÿ£ÿπŸàÿØ ÿ®ÿ£ŸÇŸàŸâ ŸÖŸÜ ŸÇÿ®ŸÑ.", "Ÿáÿ∞ÿß Ÿäÿ¨ÿπŸÑŸÜŸä ÿ£ŸÅÿ∂ŸÑ."],
                draw: ["ÿ™ÿπÿßÿØŸÑ ŸÖŸÑÿ≠ŸÖŸä!", "ŸÇŸàÿßŸÜÿß ŸÖÿ™Ÿàÿßÿ≤ŸÜÿ© ÿ™ŸÖÿßŸÖÿßŸã.", "ÿ≥ÿ£ÿ≠ŸÑŸÑ Ÿáÿ∞ÿß ŸÑŸÑÿ™ÿ≠ÿ≥ŸÜ.", "ŸÖÿπÿ±ŸÉÿ© ÿ™ÿ≥ÿ™ÿ≠ŸÇ ÿßŸÑÿ™ÿ∞ŸÉÿ±."],
                victory: ["üèÜ ÿßŸÜÿ™ÿµÿßÿ± ŸÉŸàŸÜŸä! üèÜ", "ŸÑŸÇÿØ Ÿáÿ≤ŸÖÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸäŸÑ!", "ÿ£ŸÜÿ™ ÿ™ÿ≥ÿ™ÿ≠ŸÇ Ÿáÿ∞ÿß ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤!", "ÿπÿ®ŸÇÿ±Ÿäÿ© ÿ®ÿ¥ÿ±Ÿäÿ© ÿ™ŸÅŸàŸÇ ÿßŸÑÿ™ŸàŸÇÿπÿßÿ™!"]
            },

            init() {
                try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } 
                catch(e) { console.log('Audio not supported'); }
            },

            playTone(freq, type, duration, vol = 0.08) {
                if (!this.enabled || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },

            playWin() { [523, 659, 784, 1047, 1318].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.28), i * 130)); },
            playLose() { this.playTone(260, 'sawtooth', 0.55, 0.06); },
            playDraw() { this.playTone(440, 'triangle', 0.32); setTimeout(() => this.playTone(523, 'triangle', 0.32), 270); },
            playThink() { this.playTone(580 + Math.random()*240, 'sine', 0.12, 0.035); },
            playAchievement() { this.playTone(880, 'sine', 0.2); setTimeout(() => this.playTone(1100, 'sine', 0.25), 150); },

            speak(text) { document.getElementById('aiComment').innerText = `"${text}"`; },
            getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        };

        // === COSMIC NEURAL NETWORK VISUALIZER ===
        const NeuralViz = {
            canvas: null, ctx: null, nodes: [], connections: [],
            active: false, state: 'idle',
            colors: { idle: '#00f6ff', thinking: '#fbbf24', attacking: '#f87171', defending: '#22d3ee', learning: '#a78bfa' },
            
            init() {
                this.canvas = document.getElementById('neuralCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.createNetwork();
                this.animate();
            },

            resize() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.offsetWidth * window.devicePixelRatio;
                this.canvas.height = container.offsetHeight * window.devicePixelRatio;
                this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            },

            createNetwork() {
                const count = this.active ? 55 : 32;
                const width = this.canvas.width / window.devicePixelRatio;
                const height = this.canvas.height / window.devicePixelRatio;
                
                this.nodes = [];
                for (let i = 0; i < count; i++) {
                    this.nodes.push({
                        x: Math.random() * width, y: Math.random() * height,
                        vx: (Math.random() - 0.5) * (this.active ? 2.2 : 0.7),
                        vy: (Math.random() - 0.5) * (this.active ? 2.2 : 0.7),
                        radius: Math.random() * 3 + 1.8,
                        pulse: Math.random() * Math.PI * 2,
                        color: this.colors[this.state],
                        energy: Math.random() * 0.5 + 0.5
                    });
                }
                
                this.connections = [];
                for (let i = 0; i < this.nodes.length; i++) {
                    for (let j = i + 1; j < this.nodes.length; j++) {
                        const dx = this.nodes[i].x - this.nodes[j].x;
                        const dy = this.nodes[i].y - this.nodes[j].y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < (this.active ? 85 : 62)) {
                            this.connections.push({ 
                                a: i, b: j, 
                                strength: 1 - dist/(this.active?85:62),
                                pulse: Math.random() * Math.PI * 2
                            });
                        }
                    }
                }
            },

            setState(state) {
                this.state = state;
                this.active = state !== 'idle';
                document.getElementById('neuralStatus').innerText = state.toUpperCase();
                document.getElementById('neuralStatus').style.color = this.colors[state];
                this.nodes.forEach(n => { n.color = this.colors[state]; n.energy = Math.random() * 0.5 + 0.5; });
                this.createNetwork();
            },

            animate() {
                const width = this.canvas.width / window.devicePixelRatio;
                const height = this.canvas.height / window.devicePixelRatio;
                this.ctx.clearRect(0, 0, width, height);
                
                // Draw connections
                this.connections.forEach(conn => {
                    const n1 = this.nodes[conn.a], n2 = this.nodes[conn.b];
                    const alpha = conn.strength * (this.active ? 0.8 : 0.4) * (0.6 + Math.sin(conn.pulse) * 0.4);
                    conn.pulse += 0.04;
                    this.ctx.strokeStyle = n1.color;
                    this.ctx.globalAlpha = alpha;
                    this.ctx.lineWidth = 1.4;
                    this.ctx.beginPath();
                    this.ctx.moveTo(n1.x, n1.y);
                    this.ctx.lineTo(n2.x, n2.y);
                    this.ctx.stroke();
                });
                
                // Draw nodes with glow
                this.nodes.forEach(n => {
                    n.x += n.vx; n.y += n.vy; n.pulse += 0.07;
                    if (n.x < 0 || n.x > width) n.vx *= -1;
                    if (n.y < 0 || n.y > height) n.vy *= -1;
                    
                    const pulseSize = n.radius + Math.sin(n.pulse) * 1.2;
                    
                    // Outer glow
                    const gradient = this.ctx.createRadialGradient(n.x, n.y, 0, n.x, n.y, pulseSize * 4);
                    gradient.addColorStop(0, n.color);
                    gradient.addColorStop(0.3, n.color + '90');
                    gradient.addColorStop(0.7, n.color + '40');
                    gradient.addColorStop(1, 'transparent');
                    this.ctx.fillStyle = gradient;
                    this.ctx.globalAlpha = n.energy;
                    this.ctx.beginPath();
                    this.ctx.arc(n.x, n.y, pulseSize * 4, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // Core
                    this.ctx.globalAlpha = 1;
                    this.ctx.fillStyle = '#fff';
                    this.ctx.beginPath();
                    this.ctx.arc(n.x, n.y, pulseSize * 0.7, 0, Math.PI * 2);
                    this.ctx.fill();
                });
                
                this.ctx.globalAlpha = 1;
                requestAnimationFrame(() => this.animate());
            }
        };

        // === COSMIC AI MEMORY (Universal Learning) ===
        const CosmicMemory = {
            key: 'menzo_cosmic_omniscient_v‚àû',
            
            get() {
                try {
                    const data = localStorage.getItem(this.key);
                    return data ? JSON.parse(data) : this.getInitial();
                } catch(e) { return this.getInitial(); }
            },
            
            getInitial() {
                return {
                    patterns: [], winPatterns: [], drawPatterns: [], losePatterns: [],
                    playerStyle: {}, cycles: 0, lastSync: Date.now(), 
                    accuracy: 97.2, adaptiveDiff: 1, achievements: []
                };
            },
            
            save(data) {
                data.lastSync = Date.now();
                try {
                    localStorage.setItem(this.key, JSON.stringify(data));
                    this.showSync();
                    this.updateUI();
                } catch(e) { console.log('Storage optimized'); }
            },
            
            addPattern(board, result, playerMove = null, level = 'cosmic') {
                const data = this.get();
                const hash = board.join('');
                const pattern = { 
                    hash, board: [...board], result, timestamp: Date.now(), 
                    playerMove, level, skill: data.adaptiveDiff 
                };
                
                if (!data.patterns.some(p => p.hash === hash)) {
                    data.patterns.push(pattern);
                    if (result === 'win') data.winPatterns.push(hash);
                    if (result === 'draw') data.drawPatterns.push(hash);
                    if (result === 'lose') data.losePatterns.push(hash);
                    
                    // Update player style analysis
                    if (playerMove !== null) {
                        data.playerStyle[playerMove] = (data.playerStyle[playerMove] || 0) + 1;
                    }
                    
                    data.cycles++;
                    // Improve accuracy and adapt difficulty
                    data.accuracy = Math.min(99.9, 95 + (data.cycles * 0.06));
                    if (result === 'lose') data.adaptiveDiff = Math.min(3, data.adaptiveDiff + 0.15);
                    if (result === 'win') data.adaptiveDiff = Math.max(0.5, data.adaptiveDiff - 0.08);
                    
                    // Unlock achievements
                    if (data.cycles === 10 && !data.achievements.includes('first10')) {
                        data.achievements.push('first10');
                        showAchievement('üéØ ŸÖÿ≠ÿßÿ±ÿ® ŸÖÿ®ÿ™ÿØÿ¶: 10 ŸÖÿ®ÿßÿ±Ÿäÿßÿ™');
                    }
                    if (data.cycles === 50 && !data.achievements.includes('first50')) {
                        data.achievements.push('first50');
                        showAchievement('‚öîÔ∏è ŸÖÿ≠ÿ™ÿ±ŸÅ: 50 ŸÖÿπÿ±ŸÉÿ©');
                    }
                    if (data.losePatterns.length >= 3 && !data.achievements.includes('challenger')) {
                        data.achievements.push('challenger');
                        showAchievement('üèÜ ÿ™ÿ≠ÿØŸä ÿßŸÑÿ£ÿ≥ÿ∑Ÿàÿ±ÿ©: Ÿáÿ≤ŸÖÿ™ ÿßŸÑÿ∞ŸÉÿßÿ° 3 ŸÖÿ±ÿßÿ™!');
                    }
                    
                    this.save(data);
                    return true;
                }
                return false;
            },
            
            getInsight(board, isAIMove = true, level = 'cosmic') {
                const data = this.get();
                const hash = board.join('');
                
                // Check historical outcomes across all levels
                const history = data.patterns.filter(p => p.hash === hash);
                if (history.length > 0) {
                    const losses = history.filter(p => p.result === 'lose').length;
                    const draws = history.filter(p => p.result === 'draw').length;
                    
                    if (losses > 0 && isAIMove) return { type: 'avoid', reason: 'Led to defeat previously', confidence: losses / history.length };
                    if (draws > 0 && isAIMove) return { type: 'improve', reason: 'Previously resulted in draw', confidence: draws / history.length };
                }
                
                // Player pattern prediction
                if (!isAIMove && Object.keys(data.playerStyle).length > 5) {
                    const preferred = Object.entries(data.playerStyle).sort((a,b) => b[1] - a[1])[0];
                    if (preferred && board[preferred[0]] === null) {
                        return { type: 'predict', reason: `Player prefers position ${preferred[0]}`, confidence: preferred[1] / Math.max(1, data.cycles) };
                    }
                }
                
                return null;
            },
            
            showSync() {
                const bar = document.getElementById('uploadBar');
                const progress = document.getElementById('uploadProgress');
                bar.style.display = 'block';
                progress.style.width = '0%';
                setTimeout(() => progress.style.width = '40%', 140);
                setTimeout(() => progress.style.width = '85%', 380);
                setTimeout(() => { progress.style.width = '100%'; setTimeout(() => bar.style.display = 'none', 280); }, 700);
            },
            
            updateUI() {
                const data = this.get();
                document.getElementById('savedPatterns').innerText = data.patterns.length;
                document.getElementById('learningCycles').innerText = data.cycles;
                document.getElementById('predictionAcc').innerText = data.accuracy.toFixed(1) + '%';
                
                const moves = Object.values(data.playerStyle);
                if (moves.length > 0) {
                    const avg = moves.reduce((a,b) => a+b, 0) / moves.length;
                    const style = avg > 3.5 ? 'ÿπÿØŸàÿßŸÜŸä' : avg > 1.8 ? 'ŸÖÿ™Ÿàÿßÿ≤ŸÜ' : 'ÿØŸÅÿßÿπŸä';
                    document.getElementById('playerAdapt').innerText = style;
                }
                
                const diff = data.adaptiveDiff;
                document.getElementById('adaptiveDiff').innerText = diff > 2 ? 'ÿµÿπÿ®' : diff > 1.2 ? 'ŸÖÿ™Ÿàÿßÿ≤ŸÜ' : 'ÿ≥ŸáŸÑ';
            }
        };

        // === UI FUNCTIONS ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const isMobile = window.innerWidth <= 1150;
            if (isMobile) sidebar.classList.toggle('visible');
            else sidebar.classList.toggle('hidden');
        }

        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        document.getElementById('closeSidebar').addEventListener('click', toggleSidebar);

        function addLog(msg, type = 'sys') {
            const log = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            entry.innerHTML = `<span class="log-time">${time}</span><span class="log-msg ${type}">${msg}</span>`;
            log.insertBefore(entry, log.firstChild);
            if (log.children.length > 40) log.removeChild(log.lastChild);
        }

        function showAchievement(text) {
            const badge = document.getElementById('achievement');
            badge.innerText = text;
            badge.classList.add('show');
            AudioSys.playAchievement();
            setTimeout(() => badge.classList.remove('show'), 4000);
        }

        // FIXED: Pass button element directly
        function setLevel(level, btn) {
            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            currentLevel = level;
            addLog(`üéÆ Level: ${level.toUpperCase()}`, 'sys');
            
            const statusMap = {
                novice: "üå± Casual Mode - Learning Enabled",
                tactical: "‚öîÔ∏è Tactical Analysis + Pattern Learning",
                divine: "üëë Minimax God Mode + Adaptive Learning",
                cosmic: "‚ú® Self-Evolving Cosmic Intelligence"
            };
            document.getElementById('statusSub').innerText = statusMap[level] || statusMap.cosmic;
            
            if (level === 'cosmic') {
                AudioSys.speak(AudioSys.getRandom(AudioSys.comments.start));
                CosmicMemory.updateUI();
            }
            resetGame();
            if (window.innerWidth <= 1150) document.getElementById('sidebar').classList.remove('visible');
        }

        // === COSMIC PARTICLES ===
        function initCosmicParticles() {
            const container = document.getElementById('cosmicParticles');
            const colors = ['var(--cosmic-cyan)', 'var(--cosmic-pink)', 'var(--cosmic-gold)', 'var(--cosmic-purple)'];
            for (let i = 0; i < 70; i++) {
                const p = document.createElement('div');
                p.className = 'cosmic-particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.width = (2 + Math.random() * 4) + 'px';
                p.style.height = p.style.width;
                p.style.background = colors[Math.floor(Math.random() * colors.length)];
                p.style.animationDelay = Math.random() * 12 + 's';
                p.style.animationDuration = (10 + Math.random() * 8) + 's';
                container.appendChild(p);
            }
        }

        // === GAME ENGINE ===
        const boardEl = document.getElementById('board');
        const statusMain = document.getElementById('statusMain');
        const statusSub = document.getElementById('statusSub');
        const aiComment = document.getElementById('aiComment');
        const winPath = document.getElementById('winPath');
        const celebrationOverlay = document.getElementById('celebrationOverlay');

        let board = Array(9).fill(null);
        let gameActive = true;
        let currentPlayer = 'X';
        let currentLevel = 'cosmic';
        let moveHistory = [];
        let playerSkill = 1;
        
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

        function initBoard() {
            boardEl.innerHTML = '<svg class="winning-svg"><path id="winPath" class="winning-path" d="" /></svg>';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                cell.addEventListener('click', () => handleCellClick(i));
                boardEl.appendChild(cell);
            }
        }
        initBoard();

        // Initialize all systems
        ThemeSys.init();
        AudioSys.init();
        NeuralViz.init();
        CosmicMemory.updateUI();
        initCosmicParticles();

        // Start button handler
        document.getElementById('startBtn').addEventListener('click', () => {
            document.getElementById('startScreen').classList.add('hidden');
            setTimeout(() => {
                addLog('‚ú® Cosmic Omniscient Ready', 'sys');
                addLog('üë®‚Äçüíª Engineered by Mohamed El-Menzalawy', 'sys');
                if (currentLevel === 'cosmic') aiComment.innerText = `"${AudioSys.getRandom(AudioSys.comments.start)}"`;
            }, 600);
        });

        function handleCellClick(index) {
            if (board[index] || !gameActive || currentPlayer !== 'X') return;
            AudioSys.playTone(740, 'sine', 0.1);
            makeMove(index, 'X');
            moveHistory.push({ player: 'X', index, board: [...board] });
            
            if (gameActive) {
                currentPlayer = 'O';
                statusMain.innerText = "AI THINKING";
                statusMain.classList.remove('victory');
                NeuralViz.setState('thinking');
                aiComment.innerText = `"${AudioSys.getRandom(AudioSys.comments.thinking)}"`;
                
                const thinkInterval = setInterval(() => AudioSys.playThink(), 140);
                
                setTimeout(() => {
                    clearInterval(thinkInterval);
                    NeuralViz.setState('idle');
                    makeComputerMove();
                }, 650 + Math.random() * 550);
            }
        }

        function makeMove(index, player) {
            board[index] = player;
            const cell = boardEl.children[index + 1];
            cell.innerText = player;
            cell.classList.add(player.toLowerCase());
            
            const winCombo = checkWin(board, player);
            if (winCombo) endGame(player, winCombo);
            else if (!board.includes(null)) endGame('draw');
        }

        function makeComputerMove() {
            if (!gameActive) return;
            let moveIndex;
            
            if (currentLevel === 'novice') {
                if (Math.random() < 0.5) moveIndex = getRandomMove();
                else moveIndex = getBestMove(2);
            } else if (currentLevel === 'tactical') {
                if (Math.random() < 0.25) moveIndex = getRandomMove();
                else moveIndex = getBestMove(5);
            } else if (currentLevel === 'divine') {
                moveIndex = getBestMove(9);
            } else if (currentLevel === 'cosmic') {
                moveIndex = getCosmicMove();
            }
            
            makeMove(moveIndex, 'O');
            moveHistory.push({ player: 'O', index: moveIndex, board: [...board] });
            
            if (gameActive) {
                currentPlayer = 'X';
                statusMain.innerText = "YOUR TURN";
                
                const lastPlayerMove = [...moveHistory].reverse().find(m => m.player === 'X');
                if (lastPlayerMove && isStrategicMove(board, lastPlayerMove.index, 'X')) {
                    aiComment.innerText = `"${AudioSys.getRandom(AudioSys.comments.goodMove)}"`;
                    playerSkill = Math.min(10, playerSkill + 0.35);
                } else {
                    aiComment.innerText = `"${AudioSys.getRandom(AudioSys.comments.badMove)}"`;
                    playerSkill = Math.max(1, playerSkill - 0.12);
                }
            }
        }

        // === COSMIC AI ALGORITHMS ===
        function getRandomMove() {
            const available = board.map((v, i) => v === null ? i : null).filter(v => v !== null);
            return available[Math.floor(Math.random() * available.length)];
        }

        function getBestMove(depth) {
            let bestScore = -Infinity, move = -1;
            let alpha = -Infinity, beta = Infinity;
            
            for (let i = 0; i < 9; i++) {
                if (board[i] === null) {
                    board[i] = 'O';
                    const score = minimax(board, 0, false, alpha, beta, depth);
                    board[i] = null;
                    if (score > bestScore) { bestScore = score; move = i; }
                    alpha = Math.max(alpha, score);
                    if (beta <= alpha) break;
                }
            }
            return move;
        }

        function minimax(board, depth, isMaximizing, alpha, beta, depthLimit) {
            if (checkWin(board, 'O')) return 10 - depth;
            if (checkWin(board, 'X')) return depth - 10;
            if (!board.includes(null)) return 0;
            if (depth >= depthLimit) return evaluateBoard(board);
            
            if (isMaximizing) {
                let bestScore = -Infinity;
                for (let i = 0; i < 9; i++) {
                    if (board[i] === null) {
                        board[i] = 'O';
                        const score = minimax(board, depth + 1, false, alpha, beta, depthLimit);
                        board[i] = null;
                        bestScore = Math.max(score, bestScore);
                        alpha = Math.max(alpha, score);
                        if (beta <= alpha) break;
                    }
                }
                return bestScore;
            } else {
                let bestScore = Infinity;
                for (let i = 0; i < 9; i++) {
                    if (board[i] === null) {
                        board[i] = 'X';
                        const score = minimax(board, depth + 1, true, alpha, beta, depthLimit);
                        board[i] = null;
                        bestScore = Math.min(score, bestScore);
                        beta = Math.min(beta, score);
                        if (beta <= alpha) break;
                    }
                }
                return bestScore;
            }
        }

        function evaluateBoard(boardState) {
            let score = 0;
            if (boardState[4] === 'O') score += 4; if (boardState[4] === 'X') score -= 4;
            [0,2,6,8].forEach(i => { if (boardState[i] === 'O') score += 1.5; if (boardState[i] === 'X') score -= 1.5; });
            wins.forEach(combo => {
                const values = combo.map(i => boardState[i]);
                const oCount = values.filter(v => v === 'O').length;
                const xCount = values.filter(v => v === 'X').length;
                if (oCount === 2 && xCount === 0) score += 6;
                if (xCount === 2 && oCount === 0) score -= 6;
            });
            return score;
        }

        // COSMIC LEVEL: Ultimate Hybrid AI
        function getCosmicMove() {
            const simulations = 25;
            const moveScores = {};
            const available = board.map((v, i) => v === null ? i : null).filter(v => v !== null);
            
            // Monte Carlo + Minimax hybrid evaluation
            available.forEach(move => {
                let totalScore = 0;
                for (let s = 0; s < simulations; s++) {
                    const simBoard = [...board];
                    simBoard[move] = 'O';
                    totalScore += simulateGame(simBoard, 'X');
                }
                // Blend with minimax for precision
                const minimaxScore = getMinimaxScoreForMove(move, 7);
                moveScores[move] = (totalScore / simulations) * 0.4 + minimaxScore * 0.6;
            });
            
            let bestMove = available[0], bestScore = -Infinity;
            for (const [move, score] of Object.entries(moveScores)) {
                if (score > bestScore) { bestScore = score; bestMove = parseInt(move); }
            }
            
            // Apply cosmic memory insights
            const testBoard = [...board];
            testBoard[bestMove] = 'O';
            const insight = CosmicMemory.getInsight(testBoard, true, currentLevel);
            
            if (insight && insight.confidence > 0.35) {
                addLog(`üß† Cosmic Insight: ${insight.reason} (${(insight.confidence*100).toFixed(0)}%)`, 'learn');
                if (insight.type === 'avoid') {
                    const alt = available.find(m => {
                        const tb = [...board]; tb[m] = 'O';
                        return !CosmicMemory.getInsight(tb, true, currentLevel);
                    });
                    if (alt !== undefined) return alt;
                }
            }
            
            // Player prediction with neural analysis
            const playerInsight = CosmicMemory.getInsight(board, false, currentLevel);
            if (playerInsight && playerInsight.type === 'predict') {
                NeuralViz.setState('attacking');
                addLog(`üéØ Predicting: ${playerInsight.reason}`, 'ai');
            }
            
            return bestMove;
        }

        function getMinimaxScoreForMove(move, depth) {
            const original = board[move];
            board[move] = 'O';
            const score = minimax(board, 0, false, -Infinity, Infinity, depth);
            board[move] = original;
            return score;
        }

        function simulateGame(boardState, currentPlayer) {
            let simBoard = [...boardState];
            let simPlayer = currentPlayer;
            
            for (let depth = 0; depth < 10; depth++) {
                const available = simBoard.map((v, i) => v === null ? i : null).filter(v => v !== null);
                if (available.length === 0) break;
                
                // Weighted random with strategic bias
                const weights = available.map(idx => {
                    const test = [...simBoard]; test[idx] = simPlayer;
                    if (checkWin(test, simPlayer)) return 100;
                    return 1 + evaluateBoard(test) * 0.3;
                });
                const total = weights.reduce((a,b) => a+b, 0);
                let rand = Math.random() * total;
                let move = available[0];
                for (let i = 0; i < available.length; i++) {
                    rand -= weights[i];
                    if (rand <= 0) { move = available[i]; break; }
                }
                
                simBoard[move] = simPlayer;
                if (checkWin(simBoard, simPlayer)) return simPlayer === 'O' ? 12 : -12;
                simPlayer = simPlayer === 'O' ? 'X' : 'O';
            }
            return evaluateBoard(simBoard) * 0.15;
        }

        function checkWin(boardState, player) {
            return wins.some(combo => combo.every(i => boardState[i] === player));
        }

        function isStrategicMove(boardState, index, player) {
            const testBoard = [...boardState];
            testBoard[index] = player;
            for (const combo of wins) {
                const count = combo.filter(i => testBoard[i] === player).length;
                if (count === 2 && combo.includes(index)) return true;
            }
            return [4].includes(index) && boardState.filter(v => v !== null).length < 4;
        }

        function endGame(winner, combo = null) {
            gameActive = false;
            NeuralViz.setState('idle');
            let result, logType;
            
            if (winner === 'draw') {
                result = 'draw'; logType = 'draw';
                statusMain.innerText = "COSMIC DRAW";
                aiComment.innerText = `"${AudioSys.getRandom(AudioSys.comments.draw)}"`;
                AudioSys.playDraw();
                addLog('ü§ù Epic cosmic draw', 'draw');
                CosmicMemory.addPattern([...board], 'draw', moveHistory.filter(m => m.player === 'X').pop()?.index, currentLevel);
                
            } else {
                if (winner === 'X') {
                    result = 'lose'; logType = 'win';
                    statusMain.innerText = "COSMIC VICTORY!";
                    statusMain.classList.add('victory');
                    aiComment.innerText = `"${AudioSys.getRandom(AudioSys.comments.victory)}"`;
                    AudioSys.playWin();
                    triggerVictoryCelebration();
                    addLog('üèÜ Player achieved COSMIC victory!', 'win');
                    playerSkill = Math.min(10, playerSkill + 0.6);
                    CosmicMemory.addPattern([...board], 'lose', moveHistory.filter(m => m.player === 'X').pop()?.index, currentLevel);
                    
                } else {
                    result = 'win'; logType = 'lose';
                    statusMain.innerText = "AI COSMIC WIN";
                    statusMain.classList.remove('victory');
                    aiComment.innerText = `"${AudioSys.getRandom(AudioSys.comments.win)}"`;
                    AudioSys.playLose();
                    addLog('ü§ñ AI secured cosmic victory', 'lose');
                    playerSkill = Math.max(1, playerSkill - 0.25);
                    CosmicMemory.addPattern([...board], 'win', null, currentLevel);
                }
                if (combo) drawWinLine(combo);
            }
            
            CosmicMemory.updateUI();
        }

        // FIXED: Winning line draws correctly across any 3 cells
        function drawWinLine(combo) {
            const cell1 = boardEl.children[combo[0] + 1];
            const cell3 = boardEl.children[combo[2] + 1];
            const boardRect = boardEl.getBoundingClientRect();
            const r1 = cell1.getBoundingClientRect();
            const r3 = cell3.getBoundingClientRect();
            
            const x1 = r1.left + r1.width/2 - boardRect.left;
            const y1 = r1.top + r1.height/2 - boardRect.top;
            const x2 = r3.left + r3.width/2 - boardRect.left;
            const y2 = r3.top + r3.height/2 - boardRect.top;
            
            const path = document.getElementById('winPath');
            path.setAttribute('d', `M ${x1} ${y1} L ${x2} ${y2}`);
            setTimeout(() => path.style.strokeDashoffset = '0', 140);
        }

        // === EPIC VICTORY CELEBRATION ===
        function triggerVictoryCelebration() {
            const overlay = celebrationOverlay;
            overlay.classList.add('active');
            document.querySelector('.main-stage').classList.add('screen-shake');
            setTimeout(() => document.querySelector('.main-stage').classList.remove('screen-shake'), 650);
            
            const colors = ['var(--cosmic-cyan)', 'var(--cosmic-pink)', 'var(--cosmic-gold)', 'var(--cosmic-green)', '#ffffff'];
            
            for (let i = 0; i < 150; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.width = (10 + Math.random() * 14) + 'px';
                    confetti.style.height = (16 + Math.random() * 20) + 'px';
                    confetti.style.animationDuration = (3 + Math.random() * 2.5) + 's';
                    confetti.style.animationDelay = Math.random() * 1 + 's';
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '4px';
                    overlay.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 5000);
                }, i * 22);
            }
            setTimeout(() => overlay.classList.remove('active'), 5000);
        }

        // === UTILITIES ===
        function getHint() {
            if (!gameActive || currentPlayer !== 'X') return;
            let bestScore = -Infinity, bestMove = -1;
            for (let i = 0; i < 9; i++) {
                if (board[i] === null) {
                    board[i] = 'X';
                    const score = minimax(board, 0, false, -Infinity, Infinity, 7);
                    board[i] = null;
                    if (score > bestScore) { bestScore = score; bestMove = i; }
                }
            }
            if (bestMove !== -1) {
                const cell = boardEl.children[bestMove + 1];
                cell.style.boxShadow = `inset 0 0 50px var(--cosmic-gold), 0 0 40px var(--cosmic-gold)`;
                cell.style.borderColor = 'var(--cosmic-gold)';
                setTimeout(() => { cell.style.boxShadow = ''; cell.style.borderColor = ''; }, 3000);
                statusSub.innerText = `üí° Cosmic Hint: Position ${bestMove}`;
                addLog(`üí° Hint: Optimal cosmic move at ${bestMove}`, 'sys');
            }
        }

        function resetGame() {
            board = Array(9).fill(null);
            gameActive = true;
            currentPlayer = 'X';
            moveHistory = [];
            statusMain.innerText = "COSMIC";
            statusMain.classList.remove('victory');
            statusSub.innerText = currentLevel === 'cosmic' ? 
                "‚ú® Self-Evolving Cosmic Intelligence" : "Processing...";
            aiComment.innerText = '';
            document.getElementById('winPath').style.strokeDashoffset = '1000';
            
            document.querySelectorAll('.cell').forEach(cell => {
                cell.innerText = '';
                cell.classList.remove('x', 'o');
                cell.style.boxShadow = '';
                cell.style.borderColor = '';
            });
            addLog('üîÑ New cosmic match initialized', 'sys');
            
            if (currentLevel === 'cosmic' && Math.random() > 0.55) {
                setTimeout(() => aiComment.innerText = `"${AudioSys.getRandom(AudioSys.comments.start)}"`, 450);
            }
        }

    </script>
</body>
    </html>
